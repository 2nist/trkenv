<!doctype html>
<meta charset="utf-8" />
<title>Audio Engine</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 16px; }
  .row { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
  input[type="text"] { width: 520px; padding: 6px; }
  button { padding: 8px 12px; }
  #logs { background:#111; color:#ddd; padding:10px; height:200px; overflow:auto; white-space:pre-wrap; }
  #arts { margin-top: 10px; }
  .muted { color:#666; }
  a { color: #1a6; }
  .small { font-size: 12px; }
  .ok { color: #2a2; }
  .warn { color: #f93; }
</style>
<body>
  <h2>Audio Engine</h2>
  <div class="row">
    <input id="uri" type="text" placeholder="file:///C:/path/to/audio.wav or mp3" />
    <input id="file" type="file" accept="audio/*" />
    <button id="upload">Upload</button>
  </div>
  <div class="row">
    <input id="playlistUri" type="text" placeholder="file:///C:/path/to/playlist.m3u (optional)" />
    <input id="playlistFile" type="file" accept=".m3u,.m3u8,.txt" title="Choose a playlist file (.m3u, .m3u8, .txt)" />
    <button id="uploadPlaylist">Upload Playlist</button>
  </div>
  <div class="row">
    <button id="run">Run</button>
    <span class="small muted">Uploads save copies to runs/_uploads and fill the URIs. Values persist locally.</span>
  </div>

  <h3>Logs</h3>
  <pre id="logs">Ready.</pre>

  <h3>Artifacts</h3>
  <div id="arts" class="muted">No artifacts yet.</div>

  <script>
    const qs = (s) => document.querySelector(s);
    const logs = qs('#logs');
    const arts = qs('#arts');
    const fileInput = qs('#file');
    const uriInput = qs('#uri');
    const plFileInput = qs('#playlistFile');
    const plUriInput = qs('#playlistUri');

    const LS_AUDIO = 'trk.audio.uri';
    const LS_PLAYLIST = 'trk.playlist.uri';

    async function postJSON(url, body) {
      const r = await fetch(url, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(body || {}) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function saveState() {
      try {
        localStorage.setItem(LS_AUDIO, uriInput.value || '');
        localStorage.setItem(LS_PLAYLIST, plUriInput.value || '');
      } catch {}
    }

    function restoreState() {
      try {
        const a = localStorage.getItem(LS_AUDIO);
        const p = localStorage.getItem(LS_PLAYLIST);
        if (a) uriInput.value = a;
        if (p) plUriInput.value = p;
      } catch {}
    }
    async function upload() {
      const f = fileInput.files?.[0];
      if (!f) { alert('Choose a file first'); return; }
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch('/api/uploads', { method: 'POST', body: fd });
      if (!r.ok) { alert('Upload failed'); return; }
      const js = await r.json();
      uriInput.value = js.uri;
      saveState();
    }

    async function uploadPlaylist() {
      const f = plFileInput.files?.[0];
      if (!f) { alert('Choose a playlist file first'); return; }
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch('/api/uploads', { method: 'POST', body: fd });
      if (!r.ok) { alert('Upload failed'); return; }
      const js = await r.json();
      plUriInput.value = js.uri;
      saveState();
    }

    function streamLogs(jobId) {
      const es = new EventSource('/api/jobs/' + jobId + '/logs/stream');
      es.onmessage = (ev) => { logs.textContent += '\n' + ev.data; logs.scrollTop = logs.scrollHeight; };
      es.onerror = () => { /* ignore */ };
    }

    async function refreshArtifacts(jobId) {
      const r = await fetch('/api/jobs/' + jobId + '/artifacts');
      if (!r.ok) return;
      const js = await r.json();
      if (!js.artifacts?.length) { arts.textContent = 'No artifacts.'; return; }
      arts.innerHTML = '';
      for (const a of js.artifacts) {
        const el = document.createElement('div');
        el.innerHTML = `<a href="${a.uri}" target="_blank">${a.name}</a> <span class="small muted">(${a.size} bytes)</span>`;
        arts.appendChild(el);
      }
    }

    async function runJob() {
      const uri = uriInput.value.trim();
      const playlist = plUriInput.value.trim();
      if (!uri && !playlist) { alert('Provide audio URI or playlist, or upload a file.'); return; }
      logs.textContent = 'Starting job...';
      arts.textContent = 'Waiting for artifacts...';
      const payload = {};
      if (uri) payload.audio = uri;
      if (playlist) payload.playlist = playlist;
      saveState();
      const js = await postJSON('/api/experiments/audio-engine/jobs', payload);
      const id = js.jobId;
      streamLogs(id);
      // Poll artifacts until job completes (simple approach)
      const t = setInterval(async () => {
        const r = await fetch('/api/jobs/' + id + '/artifacts');
        if (!r.ok) return;
        const info = await r.json();
        await refreshArtifacts(id);
        if (info.status === 'completed' || info.status === 'failed') { clearInterval(t); }
      }, 1000);
    }

    qs('#upload').onclick = upload;
    qs('#uploadPlaylist').onclick = uploadPlaylist;
    qs('#run').onclick = runJob;

    restoreState();
  </script>
</body>
